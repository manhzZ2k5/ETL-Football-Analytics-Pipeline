# Docker Compose file cho Airflow ETL với PostgreSQL local
# PostgreSQL đã có sẵn trên máy local, không cần chạy trong Docker

version: '3.8'

services:
  # Airflow Init (Chạy 1 lần để khởi tạo database schema)
  airflow-init:
    build:
      context: .
      dockerfile: Dockerfile
    entrypoint: /bin/bash
    command:
      - -c
      - |
        echo "Waiting for PostgreSQL to be ready..."
        sleep 5
        echo "Initializing Airflow database..."
        airflow db init
        echo "Creating Airflow admin user..."
        airflow users create \
          --username airflow \
          --firstname Airflow \
          --lastname Admin \
          --role Admin \
          --email airflow@example.com \
          --password airflow || true
        echo "Airflow initialization completed!"
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@host.docker.internal/airflow
      ETL_FOOTBALL_BASE_DIR: /opt/airflow
    volumes:
      - ./dags:/opt/airflow/dags
      - ./scr:/opt/airflow/scr
    restart: "no"  # Chỉ chạy 1 lần

  # Airflow Webserver (Web UI)
  airflow-webserver:
    build:
      context: .           
      dockerfile: Dockerfile
    command: webserver     
    ports:
      - "8080:8080"        
    environment:
      # Kết nối đến PostgreSQL trên máy local từ container
      # host.docker.internal = địa chỉ máy host từ container (Windows/Mac)
      # Nếu Linux, có thể cần dùng IP của host hoặc network_mode: host
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@host.docker.internal/airflow
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      ETL_FOOTBALL_BASE_DIR: /opt/airflow
    volumes:
      - ./dags:/opt/airflow/dags
      - ./scr:/opt/airflow/scr
      - ./data_raw:/opt/airflow/data_raw
      - ./data_processed:/opt/airflow/data_processed
    depends_on:
      airflow-init:
        condition: service_completed_successfully
    restart: always

  # Airflow Scheduler (Chạy DAGs)
  airflow-scheduler:
    build:
      context: .
      dockerfile: Dockerfile
    command: scheduler    
    environment:
      # Kết nối đến PostgreSQL trên máy local từ container
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@host.docker.internal/airflow
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      ETL_FOOTBALL_BASE_DIR: /opt/airflow
    volumes:
      - ./dags:/opt/airflow/dags
      - ./scr:/opt/airflow/scr
      - ./data_raw:/opt/airflow/data_raw
      - ./data_processed:/opt/airflow/data_processed
    depends_on:
      airflow-init:
        condition: service_completed_successfully
    restart: always
